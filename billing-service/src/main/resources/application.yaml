# ============================================================================
# SILAT MANAGEMENT PLATFORM - COMPLETE CONFIGURATION
# ============================================================================

# Application Configuration (application.yml)
---
quarkus:
  application:
    name: silat-management-platform
    version: 1.0.0
  
  # HTTP Configuration
  http:
    port: 8080
    cors:
      ~: true
      origins: "*"
      methods: GET,POST,PUT,DELETE,OPTIONS
      headers: "*"
    
  # gRPC Configuration
  grpc:
    server:
      port: 9090
      enable-reflection-service: true
  
  # Database Configuration (PostgreSQL with Multi-tenancy)
  datasource:
    db-kind: postgresql
    username: ${DB_USERNAME:silat}
    password: ${DB_PASSWORD:silat123}
    reactive:
      url: postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:silat_management}
      max-size: 20
      idle-timeout: PT10M
  
  hibernate-orm:
    database:
      generation: update
    log:
      sql: ${DB_LOG_SQL:false}
    dialect: org.hibernate.dialect.PostgreSQLDialect
    jdbc:
      timezone: UTC
    physical-naming-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
  
  # Redis Configuration (for caching and quota tracking)
  redis:
    hosts: ${REDIS_HOST:redis://localhost:6379}
    password: ${REDIS_PASSWORD:}
    client-type: standalone
  
  # Kafka Configuration (for event streaming)
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP:localhost:9092}
    
  kafka-streams:
    application-id: silat-management
    
  # Messaging Configuration
  reactive-messaging:
    kafka:
      # Outgoing events
      tenant-events:
        connector: smallrye-kafka
        topic: silat.tenant.events
        value:
          serializer: io.quarkus.kafka.client.serialization.ObjectMapperSerializer
        acks: all
        
      # Incoming events
      tenant-events-in:
        connector: smallrye-kafka
        topic: silat.tenant.events
        group:
          id: management-event-consumer
        value:
          deserializer: io.quarkus.kafka.client.serialization.ObjectMapperDeserializer
        auto:
          offset:
            reset: earliest
  
  # Security Configuration
  security:
    enabled: true
  
  oidc:
    enabled: ${OIDC_ENABLED:false}
    auth-server-url: ${OIDC_SERVER_URL:}
    client-id: ${OIDC_CLIENT_ID:silat-management}
    credentials:
      secret: ${OIDC_CLIENT_SECRET:}
  
  # REST Client Configuration
  rest-client:
    consumer-access-api:
      url: ${CONSUMER_ACCESS_URL:http://localhost:8081}
  
  # Scheduler Configuration
  scheduler:
    enabled: true
  
  # Cache Configuration
  cache:
    caffeine:
      pricing:
        initial-capacity: 100
        maximum-size: 1000
        expire-after-write: PT1H
      
      quotas:
        initial-capacity: 1000
        maximum-size: 10000
        expire-after-write: PT5M
  
  # Observability
  log:
    level: INFO
    category:
      "tech.kayys.silat": ${LOG_LEVEL:INFO}
    console:
      format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n"
  
  # Metrics
  micrometer:
    enabled: true
    export:
      prometheus:
        enabled: true
        path: /metrics
  
  # Health Checks
  health:
    enabled: true
  
  smallrye-health:
    ui:
      enable: true
  
  # OpenAPI/Swagger
  swagger-ui:
    enable: true
    path: /swagger-ui
    always-include: true
  
  smallrye-openapi:
    path: /openapi
    info-title: Silat Management Platform API
    info-version: 1.0.0
    info-description: Management, billing, and provisioning API for Silat Workflow Platform
    info-contact-name: Silat Support
    info-contact-email: support@silat.io

# Custom Application Properties
silat:
  management:
    # Platform Configuration
    platform:
      name: Silat
      environment: ${ENVIRONMENT:production}
      region: ${REGION:us-east-1}
    
    # Billing Configuration
    billing:
      enabled: true
      currency: ${DEFAULT_CURRENCY:USD}
      invoice-due-days: 14
      grace-period-days: 7
      dunning-max-attempts: 5
    
    # Email Configuration
    email:
      provider: ${EMAIL_PROVIDER:sendgrid}
      from-address: ${EMAIL_FROM:noreply@silat.io}
      from-name: Silat Platform
      sendgrid:
        api-key: ${SENDGRID_API_KEY:}
      ses:
        region: ${AWS_REGION:us-east-1}
        access-key: ${AWS_ACCESS_KEY:}
        secret-key: ${AWS_SECRET_KEY:}
    
    # Payment Gateway Configuration
    payment:
      provider: ${PAYMENT_PROVIDER:stripe}
      stripe:
        api-key: ${STRIPE_API_KEY:}
        webhook-secret: ${STRIPE_WEBHOOK_SECRET:}
      paypal:
        client-id: ${PAYPAL_CLIENT_ID:}
        client-secret: ${PAYPAL_CLIENT_SECRET:}
    
    # Provisioning Configuration
    provisioning:
      auto-provision: true
      database:
        provider: postgresql
        host: ${DB_HOST:localhost}
        port: ${DB_PORT:5432}
      cache:
        provider: redis
        host: ${REDIS_HOST:localhost}
        port: 6379
      storage:
        provider: s3
        bucket-prefix: silat-tenant
        region: ${AWS_REGION:us-east-1}
      messaging:
        provider: kafka
        bootstrap-servers: ${KAFKA_BOOTSTRAP:localhost:9092}
    
    # Quota Configuration
    quota:
      enforcement-enabled: true
      grace-percent: 10
      alert-thresholds:
        warning: 80
        critical: 90
    
    # Monitoring
    monitoring:
      health-check-interval: 5m
      metrics-retention-days: 90
    
    # Feature Flags
    features:
      trial-enabled: true
      trial-duration-days: 14
      custom-pricing: true
      volume-discounts: true
      multi-currency: false

# ============================================================================
# Docker Compose Configuration (docker-compose.yml)
# ============================================================================
---
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: silat-management-db
    environment:
      POSTGRES_USER: silat
      POSTGRES_PASSWORD: silat123
      POSTGRES_DB: silat_management
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - silat-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U silat"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: silat-management-cache
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - silat-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
  
  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: silat-management-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - silat-network
  
  # Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: silat-management-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - silat-network
  
  # Management Platform Application
  management-app:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: silat-management-app
    depends_on:
      - postgres
      - redis
      - kafka
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      QUARKUS_PROFILE: prod
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: silat
      DB_PASSWORD: silat123
      DB_NAME: silat_management
      REDIS_HOST: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:29092
      LOG_LEVEL: INFO
    networks:
      - silat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
  
  # Prometheus (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: silat-prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - silat-network
  
  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: silat-grafana
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - silat-network

volumes:
  postgres_data:
  redis_data:
  kafka_data:
  zookeeper_data:
  prometheus_data:
  grafana_data:

networks:
  silat-network:
    driver: bridge
