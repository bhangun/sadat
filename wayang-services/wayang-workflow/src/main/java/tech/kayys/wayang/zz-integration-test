// ============================================================================
// COMPLETE INTEGRATION TESTS
// ============================================================================
package io.quarkus.ai.agent.runtime;

import io.quarkus.test.junit.QuarkusTest;
import io.restassured.RestAssured;
import io.restassured.http.ContentType;
import org.junit.jupiter.api.*;
import static io.restassured.RestAssured.given;
import static org.hamcrest.Matchers.*;

import java.util.*;

@QuarkusTest
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
public class CompleteIntegrationTest {

    private static String agentId;
    private static String executionId;

    @Test
    @Order(1)
    public void testHealthCheck() {
        given()
            .when().get("/health")
            .then()
                .statusCode(200)
                .body("status", equalTo("UP"));
    }

    @Test
    @Order(2)
    public void testCreateAgent() {
        Map<String, Object> agent = createSampleAgent();

        agentId = given()
            .header("X-API-Key", "test-key-1")
            .contentType(ContentType.JSON)
            .body(agent)
            .when()
                .post("/api/v1/agents")
            .then()
                .statusCode(201)
                .body("id", notNullValue())
                .body("name", equalTo("Test Agent"))
                .extract()
                .path("id");

        Assertions.assertNotNull(agentId);
    }

    @Test
    @Order(3)
    public void testGetAgent() {
        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .get("/api/v1/agents/" + agentId)
            .then()
                .statusCode(200)
                .body("id", equalTo(agentId))
                .body("status", equalTo("active"));
    }

    @Test
    @Order(4)
    public void testListAgents() {
        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .get("/api/v1/agents")
            .then()
                .statusCode(200)
                .body("items", notNullValue())
                .body("items.size()", greaterThan(0));
    }

    @Test
    @Order(5)
    public void testExecuteWorkflow() {
        Map<String, Object> request = Map.of(
            "input", Map.of("query", "What is AI?"),
            "workflowName", "Simple Workflow"
        );

        executionId = given()
            .header("X-API-Key", "test-key-1")
            .contentType(ContentType.JSON)
            .body(request)
            .when()
                .post("/api/v1/agents/" + agentId + "/execute")
            .then()
                .statusCode(202)
                .body("executionId", notNullValue())
                .body("status", equalTo("running"))
                .extract()
                .path("executionId");

        Assertions.assertNotNull(executionId);
    }

    @Test
    @Order(6)
    public void testGetExecutionStatus() throws InterruptedException {
        // Wait a bit for execution to complete
        Thread.sleep(2000);

        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .get("/api/v1/agents/executions/" + executionId)
            .then()
                .statusCode(200)
                .body("executionId", equalTo(executionId))
                .body("status", anyOf(equalTo("running"), equalTo("completed")));
    }

    @Test
    @Order(7)
    public void testExecuteWithOrchestration() {
        Map<String, Object> request = Map.of(
            "input", Map.of("task", "Write a haiku about AI"),
            "pattern", Map.of("type", "reflection")
        );

        given()
            .header("X-API-Key", "test-key-1")
            .contentType(ContentType.JSON)
            .body(request)
            .when()
                .post("/api/v1/agents/" + agentId + "/execute/orchestrated")
            .then()
                .statusCode(200)
                .body("success", equalTo(true))
                .body("output", notNullValue());
    }

    @Test
    @Order(8)
    public void testRateLimiting() {
        // Make 101 requests to trigger rate limit
        for (int i = 0; i < 101; i++) {
            given()
                .header("X-API-Key", "test-key-1")
                .when()
                    .get("/api/v1/agents/" + agentId);
        }

        // Next request should be rate limited
        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .get("/api/v1/agents/" + agentId)
            .then()
                .statusCode(429);
    }

    @Test
    @Order(9)
    public void testInvalidApiKey() {
        given()
            .header("X-API-Key", "invalid-key")
            .when()
                .get("/api/v1/agents/" + agentId)
            .then()
                .statusCode(401);
    }

    @Test
    @Order(10)
    public void testUpdateAgent() {
        Map<String, Object> agent = createSampleAgent();
        agent.put("id", agentId);
        agent.put("description", "Updated description");

        given()
            .header("X-API-Key", "test-key-1")
            .contentType(ContentType.JSON)
            .body(agent)
            .when()
                .put("/api/v1/agents/" + agentId)
            .then()
                .statusCode(200)
                .body("description", equalTo("Updated description"));
    }

    @Test
    @Order(11)
    public void testDeleteAgent() {
        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .delete("/api/v1/agents/" + agentId)
            .then()
                .statusCode(204);

        // Verify deleted
        given()
            .header("X-API-Key", "test-key-1")
            .when()
                .get("/api/v1/agents/" + agentId)
            .then()
                .statusCode(404);
    }

    // Helper methods
    private Map<String, Object> createSampleAgent() {
        Map<String, Object> agent = new HashMap<>();
        agent.put("id", UUID.randomUUID().toString());
        agent.put("name", "Test Agent");
        agent.put("description", "Test agent for integration testing");
        agent.put("type", "conversational");
        agent.put("status", "active");

        // LLM Config
        Map<String, Object> llmConfig = new HashMap<>();
        llmConfig.put("provider", "openai");
        llmConfig.put("model", "gpt-3.5-turbo");
        llmConfig.put("apiKey", System.getenv("OPENAI_API_KEY"));
        
        Map<String, Object> parameters = new HashMap<>();
        parameters.put("temperature", 0.7);
        parameters.put("maxTokens", 1000);
        llmConfig.put("parameters", parameters);
        
        agent.put("llmConfig", llmConfig);

        // Workflow
        List<Map<String, Object>> workflows = new ArrayList<>();
        workflows.add(createSimpleWorkflow());
        agent.put("workflows", workflows);

        return agent;
    }

    private Map<String, Object> createSimpleWorkflow() {
        Map<String, Object> workflow = new HashMap<>();
        workflow.put("id", UUID.randomUUID().toString());
        workflow.put("name", "Simple Workflow");

        List<Map<String, Object>> nodes = new ArrayList<>();
        
        // Start node
        nodes.add(createNode("start-1", "start", "Start", 100, 100));
        
        // LLM node
        Map<String, Object> llmNode = createNode("llm-1", "llm", "Process", 300, 100);
        Map<String, Object> config = new HashMap<>();
        config.put("prompt", "Answer this question: ${query}");
        llmNode.put("config", config);
        nodes.add(llmNode);
        
        // End node
        nodes.add(createNode("end-1", "end", "End", 500, 100));
        
        workflow.put("nodes", nodes);

        // Edges
        List<Map<String, Object>> edges = new ArrayList<>();
        edges.add(createEdge("edge-1", "start-1", "llm-1"));
        edges.add(createEdge("edge-2", "llm-1", "end-1"));
        workflow.put("edges", edges);

        return workflow;
    }

    private Map<String, Object> createNode(String id, String type, String name, int x, int y) {
        Map<String, Object> node = new HashMap<>();
        node.put("id", id);
        node.put("type", type);
        node.put("name", name);
        node.put("position", Map.of("x", x, "y", y));
        return node;
    }

    private Map<String, Object> createEdge(String id, String source, String target) {
        Map<String, Object> edge = new HashMap<>();
        edge.put("id", id);
        edge.put("source", source);
        edge.put("target", target);
        edge.put("type", "default");
        return edge;
    }
}

// ============================================================================
// WORKING EXAMPLE APPLICATION
// ============================================================================
package io.quarkus.ai.agent.example;

import io.quarkus.ai.agent.runtime.model.*;
import io.quarkus.ai.agent.runtime.api.AgentApi;
import jakarta.inject.Inject;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import java.util.*;

/**
 * Complete working example showing real usage
 */
@Path("/examples")
@Produces(MediaType.APPLICATION_JSON)
public class WorkingExampleResource {

    @Inject
    AgentApi agentApi;

    /**
     * Create a complete working agent with workflow
     */
    @POST
    @Path("/create-complete-agent")
    public AgentDefinition createCompleteAgent() {
        
        AgentDefinition agent = new AgentDefinition();
        agent.setId(UUID.randomUUID().toString());
        agent.setName("Complete Working Agent");
        agent.setDescription("Fully functional agent with all features");
        agent.setType(AgentDefinition.AgentType.CONVERSATIONAL);
        agent.setStatus(AgentDefinition.AgentStatus.ACTIVE);

        // LLM Configuration
        LLMConfig llmConfig = new LLMConfig();
        llmConfig.setProvider(LLMConfig.Provider.OPENAI);
        llmConfig.setModel("gpt-4");
        llmConfig.setApiKey(System.getenv("OPENAI_API_KEY"));

        LLMConfig.Parameters params = new LLMConfig.Parameters();
        params.setTemperature(0.7);
        params.setMaxTokens(2000);
        params.setSystemPrompt("You are a helpful AI assistant.");
        llmConfig.setParameters(params);

        LLMConfig.RetryConfig retryConfig = new LLMConfig.RetryConfig();
        retryConfig.setMaxRetries(3);
        retryConfig.setBackoffMultiplier(2.0);
        retryConfig.setTimeout(60000);
        llmConfig.setRetryConfig(retryConfig);

        agent.setLlmConfig(llmConfig);

        // Memory Configuration
        MemoryConfig memoryConfig = new MemoryConfig();
        memoryConfig.setType(MemoryConfig.MemoryType.BUFFER);
        memoryConfig.setStorageBackend(MemoryConfig.StorageBackend.REDIS);
        memoryConfig.setConfig(Map.of("maxMessages", 50));

        MemoryConfig.Retention retention = new MemoryConfig.Retention();
        retention.setDuration(7);
        retention.setUnit("days");
        retention.setAutoCleanup(true);
        memoryConfig.setRetention(retention);

        agent.setMemoryConfig(memoryConfig);

        // Tools
        List<Tool> tools = new ArrayList<>();
        
        Tool weatherTool = new Tool();
        weatherTool.setId(UUID.randomUUID().toString());
        weatherTool.setName("get_weather");
        weatherTool.setType(Tool.ToolType.API);
        weatherTool.setDescription("Get current weather for a location");
        weatherTool.setEnabled(true);

        Tool.ToolConfig toolConfig = new Tool.ToolConfig();
        toolConfig.setEndpoint("https://api.openweathermap.org/data/2.5/weather");
        toolConfig.setMethod("GET");
        toolConfig.setHeaders(Map.of("Accept", "application/json"));
        toolConfig.setTimeout(5000);

        Tool.ToolConfig.Authentication auth = new Tool.ToolConfig.Authentication();
        auth.setType("apiKey");
        auth.setCredentials(Map.of(
            "apiKey", System.getenv("WEATHER_API_KEY"),
            "headerName", "X-API-Key"
        ));
        toolConfig.setAuthentication(auth);

        weatherTool.setConfig(toolConfig);
        tools.add(weatherTool);

        agent.setTools(tools);

        // Personality
        AgentDefinition.Personality personality = new AgentDefinition.Personality();
        personality.setTone(AgentDefinition.Personality.Tone.FRIENDLY);
        personality.setStyle("Professional yet approachable");
        personality.setGuidelines(List.of(
            "Always be helpful and polite",
            "Provide clear and concise answers",
            "Ask clarifying questions when needed"
        ));

        agent.setPersonality(personality);

        // Capabilities
        AgentDefinition.Capabilities capabilities = new AgentDefinition.Capabilities();
        capabilities.setMultimodal(false);
        capabilities.setStreaming(true);
        capabilities.setFunctionCalling(true);
        capabilities.setCodeExecution(false);
        capabilities.setWebBrowsing(false);

        agent.setCapabilities(capabilities);

        // Safety
        AgentDefinition.Safety safety = new AgentDefinition.Safety();
        safety.setContentFiltering(true);
        safety.setPiiDetection(true);
        safety.setToxicityThreshold(0.8);
        safety.setAllowedTopics(List.of("general", "technology", "science"));
        safety.setBlockedTopics(List.of("violence", "hate_speech"));

        agent.setSafety(safety);

        // Analytics
        AgentDefinition.Analytics analytics = new AgentDefinition.Analytics();
        analytics.setEnabled(true);
        analytics.setMetrics(List.of("latency", "tokens", "cost", "success_rate"));

        AgentDefinition.Analytics.LoggingConfig logging = 
            new AgentDefinition.Analytics.LoggingConfig();
        logging.setLevel("info");
        logging.setDestination("stdout");
        analytics.setLogging(logging);

        agent.setAnalytics(analytics);

        // Create complete workflow
        agent.setWorkflows(List.of(createCompleteWorkflow()));

        // Metadata
        AgentDefinition.Metadata metadata = new AgentDefinition.Metadata();
        metadata.setCreatedAt(java.time.Instant.now());
        metadata.setUpdatedAt(java.time.Instant.now());
        metadata.setCreatedBy("example-system");
        metadata.setVersion("1.0.0");
        metadata.setTags(List.of("example", "complete", "production-ready"));

        agent.setMetadata(metadata);

        return agent;
    }

    private Workflow createCompleteWorkflow() {
        Workflow workflow = new Workflow();
        workflow.setId(UUID.randomUUID().toString());
        workflow.setName("Complete Workflow Example");
        workflow.setDescription("Demonstrates all node types");

        List<Workflow.Node> nodes = new ArrayList<>();

        // 1. START
        nodes.add(createSimpleNode("start", Workflow.Node.NodeType.START, "Start", 100, 100));

        // 2. LLM - Classify Intent
        Workflow.Node llmNode = createSimpleNode("llm-1", Workflow.Node.NodeType.LLM, 
            "Classify Intent", 300, 100);
        Workflow.Node.NodeConfig llmConfig = new Workflow.Node.NodeConfig();
        llmConfig.setPrompt("Classify the user's intent: ${query}");
        llmNode.setConfig(llmConfig);
        nodes.add(llmNode);

        // 3. CONDITION - Route based on intent
        nodes.add(createSimpleNode("cond-1", Workflow.Node.NodeType.CONDITION, 
            "Route", 500, 100));

        // 4. TOOL - Call weather API
        Workflow.Node toolNode = createSimpleNode("tool-1", Workflow.Node.NodeType.TOOL, 
            "Get Weather", 700, 50);
        nodes.add(toolNode);

        // 5. TRANSFORM - Format response
        Workflow.Node transformNode = createSimpleNode("trans-1", Workflow.Node.NodeType.TRANSFORM, 
            "Format", 900, 50);
        nodes.add(transformNode);

        // 6. VALIDATOR - Validate output
        Workflow.Node validatorNode = createSimpleNode("val-1", Workflow.Node.NodeType.VALIDATOR, 
            "Validate", 1100, 100);
        nodes.add(validatorNode);

        // 7. END
        nodes.add(createSimpleNode("end", Workflow.Node.NodeType.END, "End", 1300, 100));

        workflow.setNodes(nodes);

        // Edges
        List<Workflow.Edge> edges = new ArrayList<>();
        edges.add(createSimpleEdge("e1", "start", "llm-1"));
        edges.add(createSimpleEdge("e2", "llm-1", "cond-1"));
        edges.add(createSimpleEdge("e3", "cond-1", "tool-1"));
        edges.add(createSimpleEdge("e4", "tool-1", "trans-1"));
        edges.add(createSimpleEdge("e5", "trans-1", "val-1"));
        edges.add(createSimpleEdge("e6", "val-1", "end"));

        workflow.setEdges(edges);

        return workflow;
    }

    private Workflow.Node createSimpleNode(String id, Workflow.Node.NodeType type, 
                                          String name, int x, int y) {
        Workflow.Node node = new Workflow.Node();
        node.setId(id);
        node.setType(type);
        node.setName(name);
        
        Workflow.Node.Position position = new Workflow.Node.Position();
        position.setX((double) x);
        position.setY((double) y);
        node.setPosition(position);
        
        return node;
    }

    private Workflow.Edge createSimpleEdge(String id, String source, String target) {
        Workflow.Edge edge = new Workflow.Edge();
        edge.setId(id);
        edge.setSource(source);
        edge.setTarget(target);
        edge.setType(Workflow.Edge.EdgeType.DEFAULT);
        return edge;
    }
}

// ============================================================================
// REAL USAGE EXAMPLE SCRIPT
// ============================================================================
/*
#!/bin/bash
# complete-example.sh - Complete working example

# 1. Start services
echo "Starting services..."
docker-compose up -d

# Wait for services
sleep 10

# 2. Create agent
echo "Creating agent..."
AGENT_ID=$(curl -s -X POST http://localhost:8080/examples/create-complete-agent \
  -H "X-API-Key: test-key-1" \
  -H "Content-Type: application/json" | jq -r '.id')

echo "Agent created: $AGENT_ID"

# 3. Execute workflow
echo "Executing workflow..."
EXEC_ID=$(curl -s -X POST "http://localhost:8080/api/v1/agents/$AGENT_ID/execute" \
  -H "X-API-Key: test-key-1" \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "query": "What is the weather in New York?"
    }
  }' | jq -r '.executionId')

echo "Execution started: $EXEC_ID"

# 4. Check status
sleep 5
echo "Checking status..."
curl -s "http://localhost:8080/api/v1/agents/executions/$EXEC_ID" \
  -H "X-API-Key: test-key-1" | jq

# 5. Get agent details
echo "Getting agent details..."
curl -s "http://localhost:8080/api/v1/agents/$AGENT_ID" \
  -H "X-API-Key: test-key-1" | jq '.name, .status, .workflows[0].name'

echo "Example complete!"
*/